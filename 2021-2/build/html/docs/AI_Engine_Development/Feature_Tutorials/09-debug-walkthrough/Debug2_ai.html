<div class="rst-content">

<table>
<tr>
<td align="center"><img src="https://www.xilinx.com/content/dam/xilinx/imgs/press/media-kits/corporate/xilinx-logo.png" width="30%"/>
</td>
</tr>
<tr>
<td align="center"><h2>AI Engine Debug with AI Engine Emulator</h2>
</td>
</tr>
</table><p>AI Engine emulator provides the following features:</p>
<ul class="simple">
<li><p>Cycle approximate simulation.</p></li>
<li><p>Hardware constraints check such as AI Engine heap/stack/program memory size.</p></li>
<li><p>Functional verification of kernel code via <code class="docutils literal notranslate"><span class="pre">printf()</span></code> and value change dump (VCD) file generation.</p></li>
<li><p>Performance verification of kernel code using VCD file generation and generating profile reports.</p></li>
<li><p>Out of bound memory access checks of kernel code.</p></li>
</ul>
<p>The following steps showcase AI Engine Emulator features:</p>
<p><a class="reference external" href="#1-AI-Engine-emulator-source-code-debug">1. AI Engine Emulator Source Code Debug</a></p>
<ul class="simple">
<li><p><a class="reference external" href="#AI-Engine-emulator-source-code-debug-limitations">AI Engine Emulator Source Code Debug Limitations</a></p></li>
</ul>
<p><a class="reference external" href="#2-AI-Engine-emulator-trace-and-profile-data-generation">2. AI Engine Emulator Trace and Profile Data Generation</a></p>
<p><a class="reference external" href="#3-AI-Engine-emulator-printf-support">3. AI Engine Emulator printf support</a></p>
<ul class="simple">
<li><p><a class="reference external" href="#printf-limitations">printf Limitations</a></p></li>
</ul>
<p><a class="reference external" href="#4-AI-Engine-emulator---enable-memory-check-option">4. AI Engine Emulator –enable-memory-check option</a></p>
<p><a class="reference external" href="#5-Command-line-project-source-code-debug-with-AI-Engine-emulator">5. Command-Line Project Source Code Debug with AI Engine emulator</a></p>
<h2>Step 1. Select AI Engine Configuration</h2>
<p>From the top menu, select <strong>Emulation-AIE</strong> as the current active configuration.</p>
<img src="images/aie_sim_config.png" width="200"/>
<h2>Step 2. Build with AI Engine Emulator</h2>
<p>Right-click on AI Engine project and select <strong>Build Project</strong> to build.</p>
<img src="images/aie_sim_build.png" width="300"/>
<h2>Step 3. Debug with AI Engine Emulator</h2>
<p>Right-click on AI Engine project, select <strong>Debug As</strong> and <strong>Launch AIE Emulator</strong> to debug AI Engine project.</p>
<img src="images/he_debug_aie0.png" width="450"/>
<h2>Step 4. Source Code Debug with AI Engine Emulator</h2>
<p>After debugger is launched, the resume, disconnect, step into, step over, and step return buttons can be used to examine source code execution flow. Placing the cursor on each available button pops up information about that button’s functionality.
<img src="images/he_debug.png" width="200"/></p>
<p>From the source code view, double-click on line number to setup breakpoint. Breakpoint view will show the newly added breakpoint.</p>
<img src="images/he_debug_breakpoint.png" width="800"/><p>During debug, highlighted areas indicate changes in values since the last step.
<img src="images/he_run_aie.png"/></p>
<h2>Step 5. Verify Result</h2>
<p>AI Engine emulator output files from the design are located at <code class="docutils literal notranslate"><span class="pre">${PROJECT}/Emulation-AIE/aiesimulator_output/data</span></code>. Verify the output files <code class="docutils literal notranslate"><span class="pre">${PROJECT}/Emulation-AIE/aiesimulation_output/data/dlbf_out[0-7].txt</span></code> and <code class="docutils literal notranslate"><span class="pre">${PROJECT}/Emulation-AIE/aiesimulation_output/data/ulbf_out[0-3].txt</span></code> against golden files <code class="docutils literal notranslate"><span class="pre">${PROJECT}/data/dlbf_gold[0-7].txt</span></code> and <code class="docutils literal notranslate"><span class="pre">${PROJECT}/data/ulbf_gold[0-3].txt</span></code> to ensure that the design’s I/O functionalities are correct. Vitis IDE supports the compare with feature to compare two files, highlight the files to be compared, then right-click one of highlighted files, and select <code class="docutils literal notranslate"><span class="pre">compare</span> <span class="pre">with</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">each</span> <span class="pre">other</span> <span class="pre">with</span> <span class="pre">transformation</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">Predefined</span> <span class="pre">filters</span></code> &gt; <code class="docutils literal notranslate"><span class="pre">Remove</span> <span class="pre">timestamp</span></code>.
Selecting <code class="docutils literal notranslate"><span class="pre">each</span> <span class="pre">other</span> <span class="pre">with</span> <span class="pre">transformation</span></code> is required because AI Engine emulation inserts a timestamp for each output data.</p>
<ol class="simple">
<li><p>There are maximum four breakpoints available for each tile. Program under debug is stopped at first line of <code class="docutils literal notranslate"><span class="pre">main()</span></code>. This does not impact those available breakpoints.</p></li>
<li><p>Because the compiler <code class="docutils literal notranslate"><span class="pre">-O0</span></code> option is not supported, non-sequential execution when stepping through source code is expected.</p></li>
<li><p>If an individual kernel is highlighted, select the resume button to continue execution until next breakpoint or blocked to wait for I/O. If highlight the beamformer design, select resume button to resume all kernels execution until meet each kernel’s breakpoint or blocked  waiting for each kernel’s I/O operation.</p></li>
<li><p>Due to compiler optimization, some variables’ values are stored in registers. “N/A” is shown in variables view for those optimized variables’ values.</p></li>
</ol>
<h2>Step 1: Configuration Before Launching AI Engine Simulator</h2>
<p>Highlight beamformer sub-project, right-click to select <strong>Run As</strong> &gt; <strong>Run configurations…</strong> to enter into a configuration that allows trace and profile selection.</p>
<img src="images/aie_sim_init.png" width="450"/><p><strong>Note:</strong> Enable VCD generation for event trace and enable profile generation for selected/all tiles.</p>
<img src="images/aie_sim_init1.png" width="450"/><p><strong>Note:</strong> The <code class="docutils literal notranslate"><span class="pre">--simulation-cycle-timeout</span></code> shown in the previous image is OPTIONAL. In case of long run time, this option helps to control execution period so that trace and profile can be generated properly. Clear this option for other tests especially for source code debug to avoid shorter run time.</p>
<h2>Step 2: Launch AI Engine Emulator</h2>
<p>After run configuration is completed, right-click on beamformer sub-project to select <strong>Run As</strong> and <strong>Launch AIE Emulator</strong>.
<img src="images/aie_sim_run.png"/>
Vitis™ IDE console displays <code class="docutils literal notranslate"><span class="pre">[Warning]</span> <span class="pre">:</span> <span class="pre">Sim</span> <span class="pre">result:</span> <span class="pre">0</span></code> indicates this simulation run is completed.</p>
<h2>Step 3: Launch Vitis Analyzer</h2>
<p>Double-click on <strong>${AIE_PROJECT}/Emulation-AIE/aiesimulator_output/default.aierun_summary</strong> to launch Vitis_analyzer for event trace and profile information.
<img src="images/aie_sim_va_launch.png"/></p>
<img src="images/aie_sim_va.png"/>
<img src="images/aie_sim_profile.png"/><p><strong>Note:</strong> Click on <strong>Trace</strong> for generated event trace info. Click on <strong>Profile</strong> for selected AI Engine tiles’ profile report files. These events are timing approximately accurate and can be a good reference for how the design runs.</p>
<p>The simplest form of tracing is to use a formatted <code class="docutils literal notranslate"><span class="pre">printf()</span></code> statement in the code for printing debug messages. Visual inspection of intermediate values and addresses can help you understand the progress of program execution. No additional include files are necessary for using <code class="docutils literal notranslate"><span class="pre">printf()</span></code> other than standard C/C++ includes (<code class="docutils literal notranslate"><span class="pre">stdio.h</span></code>). You can add <code class="docutils literal notranslate"><span class="pre">printf()</span></code> statements to your code to be processed during simulation, or hardware emulation, and remove them or comment them out for hardware builds.</p>
<h2>Step 1. Add <code class="docutils literal notranslate"><span class="pre">printf</span></code> statement in source code</h2>
<p>Select <code class="docutils literal notranslate"><span class="pre">bf8x8_fst_api.cpp</span></code> file in Vitis IDE to be edited. Add <code class="docutils literal notranslate"><span class="pre">printf("prbcnt=%d\n",</span> <span class="pre">prbcnt);</span></code> statement at line 42 of <code class="docutils literal notranslate"><span class="pre">bf8x8_fst_api.cpp</span></code> file.</p>
<p><strong>Note:</strong> Adding <code class="docutils literal notranslate"><span class="pre">printf()</span></code> statements to your AI Engine kernel code will increase the compiled size of the AI Engine program. Be careful that the compiled size of your kernel code does not exceed the per-AI Engine processor memory limit of 16 KB.</p>
<h2>Step 2. Build the Project</h2>
<p>Highlight the beamformer sub-project, right-click to enable pull-down menu, and select <strong>Build Project</strong> to build the beamformer project.</p>
<h2>Step 3. Enable <code class="docutils literal notranslate"><span class="pre">printf</span></code> in Run Configuration</h2>
<p>To enable <code class="docutils literal notranslate"><span class="pre">printf()</span></code> function, it is required to specify <code class="docutils literal notranslate"><span class="pre">--profile</span></code> in run configuration.</p>
<img src="images/aie_sim_printf0.png" width="450"/>
<h2>Step 4. Run the Project</h2>
<p>Highlight the beamformer sub-project, right-click to enable pull-down menu, and select <strong>Run As</strong> and <strong>Launch AIE Emulator</strong> to run the project in Vitis IDE.</p>
<h2>Step 5. Expected result</h2>
<p>Output of <code class="docutils literal notranslate"><span class="pre">printf()</span></code> statements displays on console window.
<img src="images/aie_sim_printf.png"/></p>
<h2><code class="docutils literal notranslate"><span class="pre">printf</span></code> Limitations</h2>
<p>Adding <code class="docutils literal notranslate"><span class="pre">printf()</span></code> statements increases program memory size. Make sure not to exceed program memory size when using <code class="docutils literal notranslate"><span class="pre">printf()</span></code> statements to debug.</p>
<p>This option helps to find out of range memory access from each tile during AI Engine emulation run time, however, this option impacts run time performance negatively.
The ‘out of range’ memory access indicates valid address assignment within each section. There could be certain addresses that are not assigned between sections. Hence this option is useful to debug the design.</p>
<h2>Step 1. Identify an Invalid Address from Design</h2>
<p>From a Linux terminal that points to a valid Vitis IDE installation/setup, issue this command to list a specific tile’s valid memory addresses and sizes assigned by AI Engine compiler. Flag “A” indicates this section will be loaded into tile memory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># For Vitis IDE project</span>
<span class="nb">cd</span> <span class="si">${</span><span class="nv">PROJECT_PATH</span><span class="si">}</span>/Emulation-AIE/Work/aie/6_0/Release
<span class="c1"># For command line project</span>
<span class="nb">cd</span> <span class="si">${</span><span class="nv">PROJECT_PATH</span><span class="si">}</span>/Work/aie/6_0/Release
readelf -S 6_0
</pre></div>
</div>
<img src="images/aie_sim_mem-check1.png" width="450"/>
<h2>Step 2. Add access to an invalid memory address</h2>
<p>Add these 7 lines at line 35 of <strong>bf8x8_fst_api.cpp</strong> file to access invalid memory address access, for example 0x00039900.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#if 1</span>
    // demo
//  volatile int *loc <span class="o">=</span> <span class="o">(</span>volatile int *<span class="o">)</span>0xdeadbeef<span class="p">;</span>
    volatile int *loc <span class="o">=</span> <span class="o">(</span>volatile int *<span class="o">)</span>0x00039900<span class="p">;</span>
    int <span class="nb">test</span> <span class="o">=</span> *loc<span class="p">;</span>
<span class="c1">#endif</span>
</pre></div>
</div>
<h2>Step 3. Build the application</h2>
<p>Highlight the beamformer sub-project, right-click to enable pull-down menu, select <strong>Build Project</strong> to build the project.</p>
<h2>Step 4. Add <code class="docutils literal notranslate"><span class="pre">--enable-memory-check</span></code> option in build configuration</h2>
<p>Highlight beamformer sub-project, right-click to select <strong>Run As</strong> &gt; <strong>Run configurations…</strong>. Add <strong>–enable-memory-check</strong> option to run configuration.</p>
<h2>Step 5. Run the application</h2>
<p>Highlight the beamformer sub-project, right-click to enable pull-down menu, select <strong>Run As</strong> &gt; <strong>Launch AIE Emulator</strong> to run the project in Vitis IDE.</p>
<h2>Step 6. Expected result</h2>
<p>Access location at address 0x00039900 that is between sections and is not allowed to access. This triggers the memory check error(s) and displays at Vitis IDE console.</p>
<img src="images/aie_sim_mem-check3.png"/>
Note: The error messages may be rolled out of visible area, scroll up from console window to inspect the expected error messages.

<h2>Step 7. Additional test</h2>
<p>For invalid memory access that is out of kernel program memory range, for example 0xdeadbeef, a segfault error will be thrown regardless of whether the <code class="docutils literal notranslate"><span class="pre">--enable-memory-check</span></code> option is enabled/disabled.
Comment out line 38 and uncomment line 37 from the previous source code update. Repeat step 3 and 4 to build and run the updated code.
Expect to see the segfault error from Vitis IDE console.
<img src="images/aie_sim_mem-check4.png"/></p>
<h2>Step 8. Clean up</h2>
<p>Remove those added 7 lines of <strong>bf8x8_fst_api.cpp</strong> file from step 2 to maintain source code sanity.</p>

<p>Use cases that involve using Vitis IDE functionalities without migrating to Vitis IDE are permitted.</p>
<h2>Step 1. Download the project</h2>
<p>Clone the project source from git repository and unzip the zip file.</p>
<h2>Step 2. Build the Command-Line Project with Debug Capabilities</h2>
<p>Use this tutorial’s <code class="docutils literal notranslate"><span class="pre">Makefile.emu</span></code>  that has the <code class="docutils literal notranslate"><span class="pre">--package.enable_aie_debug</span></code>  option in the packaging step. This option inserts configuration data object (CDO) that generates stop requests for the AI Engine cores, so that they stop at the reset vector. This option is required to add debug capabilities. Issue command <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">package_dbg</span></code> with this tutorial’s <code class="docutils literal notranslate"><span class="pre">Makefile.emu</span></code> to package binaries that can be debugged.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp Makefile.emu Makefile
make
make package_dbg
</pre></div>
</div>
<p><strong>Note:</strong></p>
<ol class="simple">
<li><p>The packaged binaries that have debug capabilities require to run with the debugger. Run without the debugger will see the execution hang due to the wait for debugger invocation. Issue command <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">package</span></code> to package binaries back without debugging capabilities.</p></li>
<li><p>Beamformer design takes about 60 minutes or more to build. It depends on the build computer’s spec.</p></li>
</ol>
<h2>Step 3. Launch Hardware Emulator and Boot Petalinux</h2>
<p>There are two Linux terminals required. Both terminals are required to point to a valid Vitis IDE installation/setup area to use Vitis software platform.
From terminal 1, setup tool path properly and issue this command to launch hardware emulator and boot up Petalinux.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./launch_hw_emu.sh -add-env <span class="nv">ENABLE_RDWR_DEBUG</span><span class="o">=</span><span class="nb">true</span> -add-env <span class="nv">RDWR_DEBUG_PORT</span><span class="o">=</span><span class="m">10100</span> -pid-file emulation.pid -no-reboot -forward-port <span class="m">1440</span> <span class="m">1534</span>
<span class="c1"># Run next command in emulator shell after emulator is up and ready to debug</span>
<span class="nb">source</span> /mnt/sd-mmcblk0p1/init.sh
</pre></div>
</div>
<p>Command option explanation:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-add-env</span> <span class="pre">RDWR_DEBUG_PORT=${aie_mem_sock_port}</span></code> defines the port for communicating with the AI Engine domain. In the previous example, it is 10100.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-forward-port</span> <span class="pre">${linux_tcf_agent_port}</span></code> 1534 defines the port for the Linux TCF agent. In the previous example, it is 1440, which is the default.</p></li>
</ol>
<p>Note:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">launch_hw_emu.sh</span></code> is generated properly when the project under debug is built and packaged with the hardware emulator correctly. Update the repository’s Makefile line 3 from <code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">=</span> <span class="pre">hw</span></code> to <code class="docutils literal notranslate"><span class="pre">TARGET</span> <span class="pre">=</span> <span class="pre">hw_emu</span></code>.</p></li>
<li><p>This command takes a few minutes to run because both hardware emulator and Petalinux are required to boot up properly.</p></li>
<li><p>Wait until both hardware server and Petalinux boot up before moving to the next step.</p></li>
</ol>
<h2>Step 4. Run Host Application from Emulation Console</h2>
<p>After the emulator and Petalinux boot up, issue these commands from the emulator console (terminal 1 from step 3).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /mnt/sd-mmcblk0p1
./host.exe a.xclbin
</pre></div>
</div>
<p>Note: This step is required to initialize and debug AI Engine tiles because this design has the <code class="docutils literal notranslate"><span class="pre">--package.defer_aie_run</span></code> option.</p>
<h2>Step 5. Launch Vitis IDE and XRT Server</h2>
<p>From terminal 2, setup the tool path properly and issue this command to launch the XRT server and Vitis IDE.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>vitis -debug -flow embedded -os baremetal -port <span class="m">4352</span> -launch-script <span class="si">${</span><span class="nv">PROJECT_PATH</span><span class="si">}</span>/aie_app_debug_em.tcl
xrt_server -I30000 -S -s tcp::4352
</pre></div>
</div>
<p>Command options:</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vitis</span> <span class="pre">-debug</span></code>: Launches the Vitis IDE in standalone debug mode.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-flow</span> <span class="pre">embedded</span></code>: Specifies the embedded processor flow for the AI Engine processor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-os</span> <span class="pre">baremetal</span></code>: For baremetal OS of the AI Engine domain.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-port</span> <span class="pre">4352</span></code>: Specifies the xrt_server port as discussed in Step 3.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-launch_script</span> <span class="pre">${aie_project}/aie_app_debug_em.tcl</span></code>: Specifies the Tcl script which sets up the AI Engine debug environment.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-I30000</span></code>: Defines an idle timeout in seconds, in which the server will quit if there is no response.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-S</span></code>: Specifies print server properties in JSON format to stdout.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-s</span> <span class="pre">tcp::${xrt_server_port}</span></code>: Defines the agent listening protocol and port. It is 4352 in example, but can be any free port.</p></li>
</ol>
<p><strong>Note:</strong> Debugger could be blocked from PS execution initially. Run PS application from simulator shell so debugger stops at first line of main function (default) from AI Engine tiles.</p>
<h2>Step 6. Expected Vitis IDE</h2>
<img src="images/aie_cl_run.png"/>
<h2>Step 7. Clean up Launched Processes</h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>killall -9 pllauncher<span class="p">;</span> killall -9 qemu-system-aarch64<span class="p">;</span> killall -9 xrt_server
</pre></div>
</div>
<h1>Support</h1>
<p>GitHub issues will be used for tracking requests and bugs. For questions go to <a class="reference external" href="https://support.xilinx.com/">support.xilinx.com</a>.</p>
<h1>License</h1>
<p>Licensed under the Apache License, Version 2.0 (the “License”);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">www</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">licenses</span><span class="o">/</span><span class="n">LICENSE</span><span class="o">-</span><span class="mf">2.0</span>
</pre></div>
</div>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
<p align="center"><sup>XD005 | © Copyright 2021 Xilinx, Inc.</sup></p>
<footer>
<!-- Atalwar: Moved the footer code to layout.html to resolve conflict with the Xilinx template -->
</footer>
</div>